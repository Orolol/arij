{
  "migrationId": "2026-02-15T15-24-23-358Z",
  "projectId": "cUfHlegssamR",
  "capturedAt": "2026-02-15T15:24:23.358Z",
  "snapshot": {
    "conversations": [
      {
        "id": "d4C_MYeScFy8",
        "project_id": "cUfHlegssamR",
        "type": "epic_creation",
        "label": "Ticket Detail Panel Redesign",
        "status": "active",
        "epic_id": null,
        "provider": "codex",
        "created_at": "2026-02-14T11:01:57.881Z"
      },
      {
        "id": "40I-wrNE1jbH",
        "project_id": "cUfHlegssamR",
        "type": "epic_creation",
        "label": "Epic Code Diff Viewer",
        "status": "active",
        "epic_id": null,
        "provider": "claude-code",
        "created_at": "2026-02-15T12:32:41.392Z"
      }
    ],
    "messages": [
      {
        "id": "j0enipa5UY8t",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "user",
        "content": "We need change how the ticket details are displayed. Currently, when we click on a ticket, it open on the right side, and the reste of the board is greyed and unclickable\nWe need to change this behavior. When we click, the ticket should be selected (so we have the quick action button that appear and we can select multiple ticket), the left pan open, is a little larger than currently, and the rest of the baord isn't greyed, so we can keep selecting more ticket.",
        "metadata": null,
        "created_at": "2026-02-14T18:16:48.778Z"
      },
      {
        "id": "J7Yftq1rtpoc",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "assistant",
        "content": "This looks like a solid, well-bounded UI/interaction epic if we keep it scoped to Kanban behavior only. To avoid overlap with existing epics, frame it explicitly as a **non-modal ticket detail experience on the board** (not chat-side panel work, and not agent/session logic from the current 5-phase resume spec). It’s closest to but distinct from `Kanban Ticket Cards: Agent Activity...` and the `Unified Chat...` epics.\n\nTo keep implementation risk low, I’d scope it into three slices inside one epic: board layout change (detail panel opens on left and is wider), interaction model change (opening details also keeps ticket selection + multi-select flow intact), and modal removal behavior (no board dim/lock; full board remains clickable). I’d also add explicit non-goals: no ticket workflow/status rules, no backend schema/API changes unless absolutely required for existing quick actions.\n\nTwo clarifications before drafting title/stories/AC:\n1. When ticket detail opens, should it share the same left panel container as chat/epic panels (tab/switch), or be a separate panel area?\n2. On smaller screens, do you still want non-modal behavior, or should mobile/tablet keep a modal/sheet pattern while desktop is non-modal?",
        "metadata": null,
        "created_at": "2026-02-14T18:17:09.913Z"
      },
      {
        "id": "4nKIaN8TVhxK",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "user",
        "content": "1) Yes, same area\n2) No, ditch the modal entirely",
        "metadata": null,
        "created_at": "2026-02-14T18:19:22.719Z"
      },
      {
        "id": "79gW1KX7c8A-",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "assistant",
        "content": "Your scope is clear and should be a standalone **Kanban interaction/UI epic**: clicking a ticket both selects it and opens details in the shared left panel (wider than today), with no backdrop, no board lock, and multi-select staying active. To avoid overlap, explicitly position it as board behavior only, not chat architecture work (`Unified Chat...`) and not agent/session continuity (the current 5-phase resume spec).\n\nA good refinement is to lock three implementation slices before writing stories:  \n1. **Layout**: reuse the existing shared left-panel container, increase detail panel width, keep board fully interactive behind it.  \n2. **Selection model**: open-detail action must also mark ticket selected, preserve quick actions, and support adding/removing other selections while detail stays open.  \n3. **Modal removal**: remove dim/overlay/focus-trap behavior across all breakpoints (desktop/tablet/mobile), with keyboard/focus behavior defined for accessibility.\n\nTwo details still need precision before drafting title/story/AC:  \n1. When multiple tickets are selected, which ticket is shown in the detail panel (last clicked, first selected, or pinned)?  \n2. What exact “larger” width should we target for the left detail panel (fixed px, percentage, or responsive min/max)?",
        "metadata": null,
        "created_at": "2026-02-14T18:19:52.195Z"
      },
      {
        "id": "weFICjzB8OSl",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "user",
        "content": "1) first selected\n2) enough to have a little more room, you decide",
        "metadata": null,
        "created_at": "2026-02-14T18:32:18.131Z"
      },
      {
        "id": "sI9Et0aIvQef",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "assistant",
        "content": "This should be a standalone **Kanban-only interaction epic**, clearly separate from `Unified Chat...` and from the current 5-phase resume/session spec. A good working framing is: **“Non-Modal Kanban Ticket Details with Persistent Multi-Select.”** Scope it as frontend behavior only (no schema/API changes unless a blocker appears).\n\nTo make the later title/description/stories/AC concrete, lock these rules now: clicking a ticket card both selects it and opens details in the shared left panel; panel is wider (I’d target `clamp(420px, 34vw, 560px)`); no overlay/backdrop/focus trap on any breakpoint; board remains fully clickable; detail view follows **first-selected ticket** while quick actions and multi-select continue to work across cards.\n\nTwo decisions are still needed before drafting the epic artifacts:\n1. If the first-selected ticket is unselected while others remain, should detail switch to the next oldest selected ticket or close?\n2. Should checkbox/keyboard multi-select actions also open/switch the detail panel, or should only direct card clicks control detail content?",
        "metadata": null,
        "created_at": "2026-02-14T18:32:41.272Z"
      },
      {
        "id": "sGCX5NxN9Z37",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "user",
        "content": "Generate the final epic with user stories based on our discussion.",
        "metadata": null,
        "created_at": "2026-02-14T18:35:42.773Z"
      },
      {
        "id": "JRc0QABDJaRb",
        "project_id": "cUfHlegssamR",
        "conversation_id": "d4C_MYeScFy8",
        "role": "assistant",
        "content": "```json\n{\n  \"title\": \"Non-Modal Kanban Ticket Details with Persistent Multi-Select\",\n  \"description\": \"Rework Kanban ticket detail behavior from a blocking right-side modal to a non-modal experience in the shared left panel area. Clicking a ticket must both select it and open its details, while the board remains fully interactive for additional selections and quick actions.\\n\\nImplementation plan:\\n1. Refactor board UI state to keep ordered selection (`selectedTicketIds`) and derive `activeDetailTicketId` from the first selected ticket.\\n2. Update card interaction so primary ticket click selects the ticket and opens details in the shared left panel container (same area used by chat/epic panels).\\n3. Keep multi-select active while details are open using existing additive selection controls; additional selections must not block board interaction.\\n4. Enforce first-selected anchoring: detail content follows the first selected ticket; adding more tickets does not switch detail; if the first selected ticket is removed, promote the next oldest selected ticket; if none remain, close details.\\n5. Remove all modal mechanics across desktop/tablet/mobile: no dim layer, no pointer-event lock, no focus trap, no modal fallback.\\n6. Increase detail panel width for readability using responsive sizing target `clamp(420px, 34vw, 560px)` and preserve usable board space.\\n7. Add/adjust tests for selection-order logic, non-modal interactivity, quick-action continuity, and responsive rendering. No DB/schema/API/provider changes are expected.\",\n  \"userStories\": [\n    {\n      \"title\": \"As a project manager, I want ticket details to open in the shared left panel so that I can review details without leaving the board context.\",\n      \"description\": \"Replace the current blocking right-side modal flow with a shared left-panel detail view that reuses the existing left-panel container pattern.\",\n      \"acceptanceCriteria\": \"- [ ] Clicking a ticket opens its detail view in the shared left panel container.\\n- [ ] The right-side modal behavior is removed for ticket details.\\n- [ ] Closing the detail panel does not force navigation away from the Kanban board.\\n- [ ] The panel integration does not break existing chat/epic panel mounting behavior.\"\n    },\n    {\n      \"title\": \"As a project manager, I want clicking a ticket to automatically select it so that quick actions are immediately available.\",\n      \"description\": \"Unify ticket open and selection into one primary action to reduce clicks and enable faster bulk operations.\",\n      \"acceptanceCriteria\": \"- [ ] Primary click on a ticket marks it as selected.\\n- [ ] Primary click on a ticket opens its detail panel in the same action.\\n- [ ] Quick action controls appear as soon as at least one ticket is selected.\\n- [ ] Existing additive multi-select interactions remain available while detail is open.\"\n    },\n    {\n      \"title\": \"As a project manager, I want detail content anchored to the first-selected ticket so that multi-select does not disrupt what I am reading.\",\n      \"description\": \"Selection order must be preserved and used as the source of truth for which ticket is shown in detail.\",\n      \"acceptanceCriteria\": \"- [ ] When multiple tickets are selected, the detail panel shows the first-selected ticket.\\n- [ ] Selecting additional tickets does not change the currently shown detail ticket.\\n- [ ] If the first-selected ticket is deselected and others remain, detail switches to the next oldest selected ticket.\\n- [ ] If no tickets remain selected, the detail panel closes.\"\n    },\n    {\n      \"title\": \"As a project manager, I want the board to remain fully clickable while details are open so that I can continue selecting and managing tickets.\",\n      \"description\": \"Remove blocking UX from the detail experience so users can keep interacting with cards, lanes, and quick actions in parallel.\",\n      \"acceptanceCriteria\": \"- [ ] No backdrop or greyed overlay appears when ticket details are open.\\n- [ ] Pointer interaction with board cards and lane controls remains enabled while details are open.\\n- [ ] Users can continue adding/removing selected tickets without closing the detail panel.\\n- [ ] Quick actions always apply to the current selected set.\"\n    },\n    {\n      \"title\": \"As a project manager, I want a slightly wider detail panel on all screen sizes so that ticket content is easier to read.\",\n      \"description\": \"Increase panel width with responsive constraints while preserving board usability and keeping non-modal behavior on desktop, tablet, and mobile.\",\n      \"acceptanceCriteria\": \"- [ ] Detail panel width follows a responsive target of `clamp(420px, 34vw, 560px)` on larger viewports.\\n- [ ] Non-modal behavior is preserved on desktop, tablet, and mobile (no modal fallback).\\n- [ ] Board remains usable and scrollable while the panel is open at each breakpoint.\\n- [ ] Overflow and truncation issues in ticket detail content are resolved at the new width.\"\n    },\n    {\n      \"title\": \"As a developer, I want automated coverage for the new selection and panel behavior so that regressions are caught early.\",\n      \"description\": \"Add reducer/state and UI integration tests validating non-modal interactions, selection order, and detail anchoring.\",\n      \"acceptanceCriteria\": \"- [ ] Unit tests cover selection ordering and first-selected promotion logic.\\n- [ ] Integration tests verify no overlay/board-lock behavior when details are open.\\n- [ ] Integration tests verify click-to-select-and-open behavior and multi-select continuity.\\n- [ ] Regression tests confirm no backend/API contract changes are required for this epic.\"\n    }\n  ],\n  \"dependencies\": [\n    {\n      \"ticketId\": \"$self\",\n      \"dependsOnTicketId\": \"Unified Chat Final Cutover: Left Panel Only\"\n    }\n  ]\n}\n```",
        "metadata": null,
        "created_at": "2026-02-14T18:37:05.001Z"
      },
      {
        "id": "wo2GDt4C5T5S",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "user",
        "content": "Once an epic is donem we should have a VIew diff button that open a modal that show us the code diff. We can add comment easily to diff part that will be added to the epic ticket comments.",
        "metadata": null,
        "created_at": "2026-02-15T12:34:35.595Z"
      },
      {
        "id": "mIWWfjMPv6PH",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "assistant",
        "content": "Let me know which commenting approach you prefer:\n\n1. **Inline line comments** (recommended) — Click on any diff line to leave a comment anchored to that file+line, like GitHub PR reviews. Comments stored with file/line metadata and shown both inline in the diff and in the epic comment thread.\n\n2. **Simple global comment** — A comment box alongside the diff viewer. You write about what you see and it gets posted as a regular epic comment, no line anchoring.\n\n3. **Both modes** — Inline line comments for specific code feedback, plus a general comment box. Most flexible but more implementation work.\n\nWhich approach do you want? And any preference on diff viewer library, or should I pick the best fit for the Next.js + shadcn stack?",
        "metadata": null,
        "created_at": "2026-02-15T12:36:30.650Z"
      },
      {
        "id": "c7qS-zu1_tzV",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "user",
        "content": "**Comment UX**: Both modes",
        "metadata": null,
        "created_at": "2026-02-15T12:41:35.165Z"
      },
      {
        "id": "SRZ8W2Z0nXd9",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "assistant",
        "content": "{\"type\":\"result\",\"subtype\":\"success\",\"is_error\":false,\"duration_ms\":27261,\"duration_api_ms\":26959,\"num_turns\":6,\"result\":\"Where should the diff viewer open? This matters a lot for the UX since we need space for both the diff and inline comments:\\n\\n1. **Full-screen modal** — A large Dialog/overlay covering most of the screen, giving maximum space for the diff. The epic Sheet closes or stays behind it.\\n2. **Replace Sheet content** — The diff viewer replaces the current epic detail content inside the same Sheet panel, with a back button to return.\\n3. **Dedicated page/tab** — Opens a `/projects/[id]/epics/[epicId]/diff` route in a new tab, allowing side-by-side viewing with the epic.\\n\\nWhich do you prefer?\",\"stop_reason\":null,\"session_id\":\"aae2b6e5-700a-4e48-8c8d-9f83184b32ef\",\"total_cost_usd\":0.23022025000000002,\"usage\":{\"input_tokens\":8,\"cache_creation_input_tokens\":17409,\"cache_read_input_tokens\":191398,\"output_tokens\":1027,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":17409,\"ephemeral_5m_input_tokens\":0},\"inference_geo\":\"\",\"iterations\":[],\"speed\":\"standard\"},\"modelUsage\":{\"claude-opus-4-6\":{\"inputTokens\":8,\"outputTokens\":1027,\"cacheReadInputTokens\":191398,\"cacheCreationInputTokens\":17409,\"webSearchRequests\":0,\"costUSD\":0.23022025000000002,\"contextWindow\":200000,\"maxOutputTokens\":32000}},\"permission_denials\":[{\"tool_name\":\"AskUserQuestion\",\"tool_use_id\":\"toolu_016RTPQjPmGAdHk3vmNMYy8o\",\"tool_input\":{\"questions\":[{\"question\":\"Where should the diff viewer open?\",\"header\":\"Layout\",\"options\":[{\"label\":\"Full-screen modal\",\"description\":\"A large Dialog/overlay covering most of the screen, giving maximum space for the diff. The epic Sheet closes or stays behind it.\"},{\"label\":\"Replace epic Sheet content\",\"description\":\"The diff viewer replaces the current epic detail content inside the same Sheet panel, with a back button to return to epic details.\"},{\"label\":\"New browser tab/route\",\"description\":\"Opens a dedicated /projects/[id]/epics/[epicId]/diff page in a new tab, allowing side-by-side with the epic detail.\"}],\"multiSelect\":false}]}},{\"tool_name\":\"AskUserQuestion\",\"tool_use_id\":\"toolu_019BQudWbMAYtkxHsLgdUrRi\",\"tool_input\":{\"questions\":[{\"question\":\"Where should the diff viewer open?\",\"header\":\"Layout\",\"options\":[{\"label\":\"Full-screen modal\",\"description\":\"A large Dialog/overlay covering most of the screen, giving maximum space for the diff. The epic Sheet closes or stays behind it.\"},{\"label\":\"Replace Sheet content\",\"description\":\"The diff viewer replaces the current epic detail content inside the same Sheet panel, with a back button to return.\"},{\"label\":\"Dedicated page/tab\",\"description\":\"Opens a /projects/[id]/epics/[epicId]/diff route in a new tab, allowing side-by-side viewing with the epic.\"}],\"multiSelect\":false}]}}],\"uuid\":\"55437058-43d9-430c-97a2-bfa48f45c0fc\"}",
        "metadata": null,
        "created_at": "2026-02-15T12:42:08.106Z"
      },
      {
        "id": "80o5wS6Q4gDV",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "user",
        "content": "Full screen modal",
        "metadata": null,
        "created_at": "2026-02-15T12:45:49.326Z"
      },
      {
        "id": "9SWSf7vAtb-g",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "assistant",
        "content": "{\"type\":\"result\",\"subtype\":\"success\",\"is_error\":false,\"duration_ms\":444856,\"duration_api_ms\":443267,\"num_turns\":17,\"result\":\"The plan is ready for your review. It covers the full Epic Diff Viewer feature in 9 steps — from schema migration through to the full-screen modal with inline + general comments. Let me know if you'd like any changes before we proceed to implementation.\",\"stop_reason\":null,\"session_id\":\"aae2b6e5-700a-4e48-8c8d-9f83184b32ef\",\"total_cost_usd\":2.1353686499999998,\"usage\":{\"input_tokens\":16,\"cache_creation_input_tokens\":33114,\"cache_read_input_tokens\":792147,\"output_tokens\":11890,\"server_tool_use\":{\"web_search_requests\":0,\"web_fetch_requests\":0},\"service_tier\":\"standard\",\"cache_creation\":{\"ephemeral_1h_input_tokens\":33114,\"ephemeral_5m_input_tokens\":0},\"inference_geo\":\"\",\"iterations\":[],\"speed\":\"standard\"},\"modelUsage\":{\"claude-opus-4-6\":{\"inputTokens\":34,\"outputTokens\":22900,\"cacheReadInputTokens\":1606694,\"cacheCreationInputTokens\":101639,\"webSearchRequests\":0,\"costUSD\":2.0112607500000004,\"contextWindow\":200000,\"maxOutputTokens\":32000},\"claude-haiku-4-5-20251001\":{\"inputTokens\":7212,\"outputTokens\":4813,\"cacheReadInputTokens\":470534,\"cacheCreationInputTokens\":36622,\"webSearchRequests\":0,\"costUSD\":0.1241079,\"contextWindow\":200000,\"maxOutputTokens\":32000}},\"permission_denials\":[{\"tool_name\":\"Bash\",\"tool_use_id\":\"toolu_01DCmHq7m4exA8wMXNeXtMED\",\"tool_input\":{\"command\":\"find /home/orolol/workspace/arji/app/api/projects/\\\\[projectId\\\\]/epics -name \\\"*.ts\\\" 2>/dev/null\"}},{\"tool_name\":\"Bash\",\"tool_use_id\":\"toolu_01TB4oYE3vuoKpRVLsG23zw8\",\"tool_input\":{\"command\":\"ls -la /home/orolol/workspace/arji/app/api/projects/\\\\[projectId\\\\]/epics/ 2>/dev/null | head -20\"}},{\"tool_name\":\"Bash\",\"tool_use_id\":\"toolu_018fz33iNRwpwzBMyYeS66QM\",\"tool_input\":{\"command\":\"ls -la /home/orolol/workspace/arji/app/api/projects/\\\\[projectId\\\\]/epics/\",\"description\":\"List epic API route directories\"}},{\"tool_name\":\"mcp__plugin_context7_context7__resolve-library-id\",\"tool_use_id\":\"toolu_01Qa4N9Gme86z9huCm66bfzK\",\"tool_input\":{\"libraryName\":\"react-diff-view\",\"query\":\"React diff viewer component with inline comment widgets and unified/split view\"}},{\"tool_name\":\"WebSearch\",\"tool_use_id\":\"toolu_01QU9xF7Kg4SaKead8xJLg5x\",\"tool_input\":{\"query\":\"react-diff-view npm library API usage widget system inline comments 2025 2026\"}},{\"tool_name\":\"Write\",\"tool_use_id\":\"toolu_01Vwjr4NR7D63mr1uPnbUNEb\",\"tool_input\":{\"file_path\":\"/home/orolol/workspace/arji/.claude/plans/unified-plotting-popcorn.md\",\"content\":\"# Epic Diff Viewer with Inline Comments\\n\\n## Context\\n\\nWhen an epic is done (or in progress with a branch), there is no way to see what code was changed. Users must leave the Arij interface to inspect diffs via git CLI or GitHub. This epic adds a \\\"View Diff\\\" button on the epic detail panel that opens a full-screen modal showing the `main...branch` diff, with both inline line-anchored comments and a general comment box. All comments are stored in the existing `ticketComments` table.\\n\\n## Design Decisions\\n\\n- **Library**: `react-diff-view` + `unidiff` for React-native diff rendering with built-in widget system for inline comments\\n- **Layout**: Full-screen Dialog (95vw x 90vh) — three-zone layout: file sidebar, diff content, general comments\\n- **Comment modes**: Inline (anchored to file+line) AND general comment box\\n- **Storage**: Extend `ticketComments` with nullable `filePath` + `lineNumber` columns\\n- **Diff source**: `git diff main...branchName` (three-dot = only branch changes since divergence)\\n- **Custom renderer preferred over react-diff-view's default CSS** to avoid Tailwind/dark-mode conflicts\\n\\n---\\n\\n## Step 1: Schema Migration\\n\\nAdd two nullable columns to `ticketComments`.\\n\\n**Modify**: `lib/db/schema.ts` (line 190-200)\\n\\n```typescript\\n// Add after agentSessionId, before createdAt:\\nfilePath: text(\\\"file_path\\\"),        // nullable — set for inline diff comments\\nlineNumber: integer(\\\"line_number\\\"), // nullable — set for inline diff comments\\n```\\n\\n**Run**: `npx drizzle-kit generate && npx drizzle-kit push`\\n\\n**Modify**: `hooks/useComments.ts` (line 5-13) — add to `TicketComment` interface:\\n```typescript\\nfilePath?: string | null;\\nlineNumber?: number | null;\\n```\\n\\n---\\n\\n## Step 2: Update Comments API\\n\\n**Modify**: `app/api/projects/[projectId]/epics/[epicId]/comments/route.ts`\\n\\nIn the POST handler (line 62-71), add `filePath` and `lineNumber` to the `values` object:\\n```typescript\\nfilePath: body.filePath || null,\\nlineNumber: body.lineNumber ?? null,\\n```\\n\\nNo change needed for GET — `select()` already returns all columns.\\n\\n---\\n\\n## Step 3: New Diff API Route\\n\\n**Create**: `app/api/projects/[projectId]/epics/[epicId]/diff/route.ts`\\n\\nGET handler that:\\n1. Looks up `epic.branchName` and `project.gitRepoPath`\\n2. Runs `git diff main...branchName` via `simple-git` (already in project)\\n3. Runs `git diff main...branchName --numstat` for per-file stats\\n4. Returns `{ data: { diff, files, baseBranch, headBranch } }`\\n\\nKey details:\\n- Auto-detect main branch name (`main` or `master`)\\n- Handle missing branch gracefully (400 error)\\n- Parse `--numstat` into `Array<{ file, additions, deletions }>`\\n- Follow existing API pattern from `lib/git/manager.ts` for `simple-git` usage\\n\\n---\\n\\n## Step 4: `useDiff` Hook\\n\\n**Create**: `hooks/useDiff.ts`\\n\\n```typescript\\nexport function useDiff(projectId: string, epicId: string | null, enabled: boolean)\\n// Returns: { data: DiffData | null, loading, error, refresh }\\n```\\n\\n- `enabled` param prevents fetch until modal opens (avoids wasted API calls)\\n- No polling — diff is a snapshot; manual refresh via button\\n- Returns raw diff text for parser + structured file list for sidebar\\n\\n---\\n\\n## Step 5: Extend `useEpicComments` Hook\\n\\n**Modify**: `hooks/useEpicComments.ts`\\n\\nChange `addComment` signature from `(content: string)` to `(content: string, filePath?: string, lineNumber?: number)` and pass the new fields in the POST body.\\n\\n---\\n\\n## Step 6: Install Dependencies\\n\\n```bash\\nnpm install react-diff-view unidiff\\n```\\n\\n- `react-diff-view` v3 — React components for unified/split diff rendering with widget system\\n- `unidiff` — Parser for unified diff format\\n\\n---\\n\\n## Step 7: Diff Parser Utility\\n\\n**Create**: `lib/diff/parser.ts`\\n\\nUtility to parse raw unified diff text into structured `DiffFile[]` with hunks and lines. Can also use `react-diff-view`'s built-in `parseDiff` — evaluate at implementation time which is cleaner.\\n\\nExports:\\n- `DiffFile { oldPath, newPath, status, hunks[] }`\\n- `DiffHunk { oldStart, oldLines, newStart, newLines, header, lines[] }`\\n- `DiffLine { type: \\\"add\\\"|\\\"delete\\\"|\\\"normal\\\", content, oldLineNumber?, newLineNumber? }`\\n\\n---\\n\\n## Step 8: DiffViewer Components\\n\\n**Create 4 components in `components/diff/`:**\\n\\n### `EpicDiffViewer.tsx` — Full-screen Dialog container\\n- Wraps everything in a shadcn `Dialog` with `max-w-[95vw] h-[90vh]`\\n- Three-zone layout: file sidebar (250px) | diff content (flex-1) | bottom general comments (collapsible)\\n- Uses `useDiff` + `useEpicComments`\\n- Separates comments into inline (has filePath+lineNumber) vs general\\n- Toggle for unified/split view mode\\n- Header shows `baseBranch...headBranch` with refresh button\\n\\n### `DiffFileTree.tsx` — Left sidebar\\n- Lists changed files with `+N` / `-N` stats (green/red)\\n- Comment count badge per file\\n- Click to scroll to that file in the diff\\n- \\\"All files\\\" option to show full diff\\n\\n### `DiffContent.tsx` — Main diff rendering area\\n- Renders parsed diff files as collapsible sections\\n- Each line: old/new line numbers in gutter + colored content\\n- Hover on any line shows a \\\"+\\\" comment button\\n- Click inserts `InlineCommentWidget` below that line\\n- Existing inline comments rendered below their anchored lines\\n- Dark mode colors: `bg-green-950/30` for additions, `bg-red-950/30` for deletions\\n\\n### `InlineCommentWidget.tsx` — Comment form between diff lines\\n- Shows existing comments for this file+line (with `MarkdownContent`)\\n- Textarea for new comment (reuse `MentionTextarea` for @mentions)\\n- Submit calls `addComment(content, filePath, lineNumber)`\\n- Cancel collapses the widget\\n\\n### General comments — reuse `CommentThread` pattern\\n- Bottom collapsible panel showing only comments where `filePath` is null\\n- Standard comment input for general observations\\n\\n---\\n\\n## Step 9: Integration in EpicDetail\\n\\n**Modify**: `components/kanban/EpicDetail.tsx`\\n\\n1. Add state: `const [diffViewerOpen, setDiffViewerOpen] = useState(false)`\\n2. Add \\\"View Diff\\\" button in the branch section (after line 382, near branch name):\\n   ```tsx\\n   <Button size=\\\"sm\\\" variant=\\\"outline\\\" onClick={() => setDiffViewerOpen(true)}>\\n     <FileDiff className=\\\"h-3 w-3 mr-1\\\" /> View Diff\\n   </Button>\\n   ```\\n3. Render `<EpicDiffViewer>` conditionally when `epic.branchName` exists\\n4. Only shows when epic has a branch (the surrounding `{epic.branchName && ...}` block handles this)\\n\\n---\\n\\n## Implementation Order\\n\\n```\\nStep 1 (Schema) ──┬──> Step 2 (Comments API) ──> Step 5 (useEpicComments)\\n                  │\\n                  └──> Step 3 (Diff API) ──> Step 4 (useDiff hook)\\n                                                      │\\nStep 6 (npm install) ──────────────────────────────────┤\\n                                                      │\\nStep 7 (Parser) ───────────────────────────────────────┤\\n                                                      │\\n                                               Step 8 (Components)\\n                                                      │\\n                                               Step 9 (Integration)\\n```\\n\\nSteps 2+3 can be parallelized. Steps 4+5 can be parallelized. Step 6 is independent.\\n\\n---\\n\\n## Key Files Reference\\n\\n| File | Role |\\n|------|------|\\n| `lib/db/schema.ts:190` | `ticketComments` table — add columns here |\\n| `hooks/useComments.ts:5` | `TicketComment` interface — add fields here |\\n| `hooks/useEpicComments.ts:40` | `addComment()` — extend signature here |\\n| `app/api/.../comments/route.ts:62` | POST insert — add fields here |\\n| `components/kanban/EpicDetail.tsx:378` | Branch section — button goes here |\\n| `lib/git/manager.ts` | Reference for `simple-git` usage patterns |\\n| `components/ui/dialog.tsx` | Dialog primitive to use for modal |\\n| `components/story/CommentThread.tsx` | Reference for comment rendering pattern |\\n\\n---\\n\\n## Verification\\n\\n1. **Schema**: After migration, confirm `file_path` and `line_number` columns exist in `ticket_comments` table\\n2. **Diff API**: `curl localhost:3000/api/projects/{id}/epics/{id}/diff` returns diff JSON for an epic with a branch\\n3. **UI**: Open an epic with a branch, click \\\"View Diff\\\", verify:\\n   - Full-screen modal opens with file sidebar and diff content\\n   - Files listed with correct +/- counts\\n   - Click a file to scroll to it\\n   - Hover on diff line shows comment button\\n   - Add inline comment → appears anchored to that line\\n   - Add general comment → appears in bottom section\\n   - Both comment types visible in the regular epic comment thread\\n4. **Edge cases**: Epic with no branch → no \\\"View Diff\\\" button; empty diff → \\\"No changes\\\" message; large diff → renders without hanging\\n\"}},{\"tool_name\":\"Write\",\"tool_use_id\":\"toolu_01W1URQYaDihEg6fzPqMd7We\",\"tool_input\":{\"file_path\":\"/home/orolol/workspace/arji/.claude/plans/unified-plotting-popcorn.md\",\"content\":\"# Epic Diff Viewer with Inline Comments\\n\\n## Context\\n\\nWhen an epic is done (or in progress with a branch), there is no way to see what code was changed. Users must leave the Arij interface to inspect diffs via git CLI or GitHub. This epic adds a \\\"View Diff\\\" button on the epic detail panel that opens a full-screen modal showing the `main...branch` diff, with both inline line-anchored comments and a general comment box. All comments are stored in the existing `ticketComments` table.\\n\\n## Design Decisions\\n\\n- **Library**: `react-diff-view` + `unidiff` for React-native diff rendering with built-in widget system for inline comments\\n- **Layout**: Full-screen Dialog (95vw x 90vh) — three-zone layout: file sidebar, diff content, general comments\\n- **Comment modes**: Inline (anchored to file+line) AND general comment box\\n- **Storage**: Extend `ticketComments` with nullable `filePath` + `lineNumber` columns\\n- **Diff source**: `git diff main...branchName` (three-dot = only branch changes since divergence)\\n- **Custom renderer preferred over react-diff-view's default CSS** to avoid Tailwind/dark-mode conflicts\\n\\n---\\n\\n## Step 1: Schema Migration\\n\\nAdd two nullable columns to `ticketComments`.\\n\\n**Modify**: `lib/db/schema.ts` (line 190-200)\\n\\n```typescript\\n// Add after agentSessionId, before createdAt:\\nfilePath: text(\\\"file_path\\\"),        // nullable — set for inline diff comments\\nlineNumber: integer(\\\"line_number\\\"), // nullable — set for inline diff comments\\n```\\n\\n**Run**: `npx drizzle-kit generate && npx drizzle-kit push`\\n\\n**Modify**: `hooks/useComments.ts` (line 5-13) — add to `TicketComment` interface:\\n```typescript\\nfilePath?: string | null;\\nlineNumber?: number | null;\\n```\\n\\n---\\n\\n## Step 2: Update Comments API\\n\\n**Modify**: `app/api/projects/[projectId]/epics/[epicId]/comments/route.ts`\\n\\nIn the POST handler (line 62-71), add `filePath` and `lineNumber` to the `values` object:\\n```typescript\\nfilePath: body.filePath || null,\\nlineNumber: body.lineNumber ?? null,\\n```\\n\\nNo change needed for GET — `select()` already returns all columns.\\n\\n---\\n\\n## Step 3: New Diff API Route\\n\\n**Create**: `app/api/projects/[projectId]/epics/[epicId]/diff/route.ts`\\n\\nGET handler that:\\n1. Looks up `epic.branchName` and `project.gitRepoPath`\\n2. Runs `git diff main...branchName` via `simple-git` (already in project)\\n3. Runs `git diff main...branchName --numstat` for per-file stats\\n4. Returns `{ data: { diff, files, baseBranch, headBranch } }`\\n\\nKey details:\\n- Auto-detect main branch name (`main` or `master`)\\n- Handle missing branch gracefully (400 error)\\n- Parse `--numstat` into `Array<{ file, additions, deletions }>`\\n- Follow existing API pattern from `lib/git/manager.ts` for `simple-git` usage\\n\\n---\\n\\n## Step 4: `useDiff` Hook\\n\\n**Create**: `hooks/useDiff.ts`\\n\\n```typescript\\nexport function useDiff(projectId: string, epicId: string | null, enabled: boolean)\\n// Returns: { data: DiffData | null, loading, error, refresh }\\n```\\n\\n- `enabled` param prevents fetch until modal opens (avoids wasted API calls)\\n- No polling — diff is a snapshot; manual refresh via button\\n- Returns raw diff text for parser + structured file list for sidebar\\n\\n---\\n\\n## Step 5: Extend `useEpicComments` Hook\\n\\n**Modify**: `hooks/useEpicComments.ts`\\n\\nChange `addComment` signature from `(content: string)` to `(content: string, filePath?: string, lineNumber?: number)` and pass the new fields in the POST body.\\n\\n---\\n\\n## Step 6: Install Dependencies\\n\\n```bash\\nnpm install react-diff-view unidiff\\n```\\n\\n- `react-diff-view` v3 — React components for unified/split diff rendering with widget system\\n- `unidiff` — Parser for unified diff format\\n\\n---\\n\\n## Step 7: Diff Parser Utility\\n\\n**Create**: `lib/diff/parser.ts`\\n\\nUtility to parse raw unified diff text into structured `DiffFile[]` with hunks and lines. Can also use `react-diff-view`'s built-in `parseDiff` — evaluate at implementation time which is cleaner.\\n\\nExports:\\n- `DiffFile { oldPath, newPath, status, hunks[] }`\\n- `DiffHunk { oldStart, oldLines, newStart, newLines, header, lines[] }`\\n- `DiffLine { type: \\\"add\\\"|\\\"delete\\\"|\\\"normal\\\", content, oldLineNumber?, newLineNumber? }`\\n\\n---\\n\\n## Step 8: DiffViewer Components\\n\\n**Create 4 components in `components/diff/`:**\\n\\n### `EpicDiffViewer.tsx` — Full-screen Dialog container\\n- Wraps everything in a shadcn `Dialog` with `max-w-[95vw] h-[90vh]`\\n- Three-zone layout: file sidebar (250px) | diff content (flex-1) | bottom general comments (collapsible)\\n- Uses `useDiff` + `useEpicComments`\\n- Separates comments into inline (has filePath+lineNumber) vs general\\n- Toggle for unified/split view mode\\n- Header shows `baseBranch...headBranch` with refresh button\\n\\n### `DiffFileTree.tsx` — Left sidebar\\n- Lists changed files with `+N` / `-N` stats (green/red)\\n- Comment count badge per file\\n- Click to scroll to that file in the diff\\n- \\\"All files\\\" option to show full diff\\n\\n### `DiffContent.tsx` — Main diff rendering area\\n- Renders parsed diff files as collapsible sections\\n- Each line: old/new line numbers in gutter + colored content\\n- Hover on any line shows a \\\"+\\\" comment button\\n- Click inserts `InlineCommentWidget` below that line\\n- Existing inline comments rendered below their anchored lines\\n- Dark mode colors: `bg-green-950/30` for additions, `bg-red-950/30` for deletions\\n\\n### `InlineCommentWidget.tsx` — Comment form between diff lines\\n- Shows existing comments for this file+line (with `MarkdownContent`)\\n- Textarea for new comment (reuse `MentionTextarea` for @mentions)\\n- Submit calls `addComment(content, filePath, lineNumber)`\\n- Cancel collapses the widget\\n\\n### General comments — reuse `CommentThread` pattern\\n- Bottom collapsible panel showing only comments where `filePath` is null\\n- Standard comment input for general observations\\n\\n---\\n\\n## Step 9: Integration in EpicDetail\\n\\n**Modify**: `components/kanban/EpicDetail.tsx`\\n\\n1. Add state: `const [diffViewerOpen, setDiffViewerOpen] = useState(false)`\\n2. Add \\\"View Diff\\\" button in the branch section (after line 382, near branch name):\\n   ```tsx\\n   <Button size=\\\"sm\\\" variant=\\\"outline\\\" onClick={() => setDiffViewerOpen(true)}>\\n     <FileDiff className=\\\"h-3 w-3 mr-1\\\" /> View Diff\\n   </Button>\\n   ```\\n3. Render `<EpicDiffViewer>` conditionally when `epic.branchName` exists\\n4. Only shows when epic has a branch (the surrounding `{epic.branchName && ...}` block handles this)\\n\\n---\\n\\n## Implementation Order\\n\\n```\\nStep 1 (Schema) ──┬──> Step 2 (Comments API) ──> Step 5 (useEpicComments)\\n                  │\\n                  └──> Step 3 (Diff API) ──> Step 4 (useDiff hook)\\n                                                      │\\nStep 6 (npm install) ──────────────────────────────────┤\\n                                                      │\\nStep 7 (Parser) ───────────────────────────────────────┤\\n                                                      │\\n                                               Step 8 (Components)\\n                                                      │\\n                                               Step 9 (Integration)\\n```\\n\\nSteps 2+3 can be parallelized. Steps 4+5 can be parallelized. Step 6 is independent.\\n\\n---\\n\\n## Key Files Reference\\n\\n| File | Role |\\n|------|------|\\n| `lib/db/schema.ts:190` | `ticketComments` table — add columns here |\\n| `hooks/useComments.ts:5` | `TicketComment` interface — add fields here |\\n| `hooks/useEpicComments.ts:40` | `addComment()` — extend signature here |\\n| `app/api/.../comments/route.ts:62` | POST insert — add fields here |\\n| `components/kanban/EpicDetail.tsx:378` | Branch section — button goes here |\\n| `lib/git/manager.ts` | Reference for `simple-git` usage patterns |\\n| `components/ui/dialog.tsx` | Dialog primitive to use for modal |\\n| `components/story/CommentThread.tsx` | Reference for comment rendering pattern |\\n\\n---\\n\\n## Verification\\n\\n1. **Schema**: After migration, confirm `file_path` and `line_number` columns exist in `ticket_comments` table\\n2. **Diff API**: `curl localhost:3000/api/projects/{id}/epics/{id}/diff` returns diff JSON for an epic with a branch\\n3. **UI**: Open an epic with a branch, click \\\"View Diff\\\", verify:\\n   - Full-screen modal opens with file sidebar and diff content\\n   - Files listed with correct +/- counts\\n   - Click a file to scroll to it\\n   - Hover on diff line shows comment button\\n   - Add inline comment → appears anchored to that line\\n   - Add general comment → appears in bottom section\\n   - Both comment types visible in the regular epic comment thread\\n4. **Edge cases**: Epic with no branch → no \\\"View Diff\\\" button; empty diff → \\\"No changes\\\" message; large diff → renders without hanging\\n\"}},{\"tool_name\":\"ExitPlanMode\",\"tool_use_id\":\"toolu_01Bh5WYemoEBtovdz1CtGMSE\",\"tool_input\":{\"allowedPrompts\":[{\"tool\":\"Bash\",\"prompt\":\"install npm dependencies\"},{\"tool\":\"Bash\",\"prompt\":\"run drizzle-kit generate and push migrations\"},{\"tool\":\"Bash\",\"prompt\":\"run dev server for testing\"}],\"plan\":\"# Epic Diff Viewer with Inline Comments\\n\\n## Context\\n\\nWhen an epic is done (or in progress with a branch), there is no way to see what code was changed. Users must leave the Arij interface to inspect diffs via git CLI or GitHub. This epic adds a \\\"View Diff\\\" button on the epic detail panel that opens a full-screen modal showing the `main...branch` diff, with both inline line-anchored comments and a general comment box. All comments are stored in the existing `ticketComments` table.\\n\\n## Design Decisions\\n\\n- **Library**: `react-diff-view` + `unidiff` for React-native diff rendering with built-in widget system for inline comments\\n- **Layout**: Full-screen Dialog (95vw x 90vh) — three-zone layout: file sidebar, diff content, general comments\\n- **Comment modes**: Inline (anchored to file+line) AND general comment box\\n- **Storage**: Extend `ticketComments` with nullable `filePath` + `lineNumber` columns\\n- **Diff source**: `git diff main...branchName` (three-dot = only branch changes since divergence)\\n- **Custom renderer preferred over react-diff-view's default CSS** to avoid Tailwind/dark-mode conflicts\\n\\n---\\n\\n## Step 1: Schema Migration\\n\\nAdd two nullable columns to `ticketComments`.\\n\\n**Modify**: `lib/db/schema.ts` (line 190-200)\\n\\n```typescript\\n// Add after agentSessionId, before createdAt:\\nfilePath: text(\\\"file_path\\\"),        // nullable — set for inline diff comments\\nlineNumber: integer(\\\"line_number\\\"), // nullable — set for inline diff comments\\n```\\n\\n**Run**: `npx drizzle-kit generate && npx drizzle-kit push`\\n\\n**Modify**: `hooks/useComments.ts` (line 5-13) — add to `TicketComment` interface:\\n```typescript\\nfilePath?: string | null;\\nlineNumber?: number | null;\\n```\\n\\n---\\n\\n## Step 2: Update Comments API\\n\\n**Modify**: `app/api/projects/[projectId]/epics/[epicId]/comments/route.ts`\\n\\nIn the POST handler (line 62-71), add `filePath` and `lineNumber` to the `values` object:\\n```typescript\\nfilePath: body.filePath || null,\\nlineNumber: body.lineNumber ?? null,\\n```\\n\\nNo change needed for GET — `select()` already returns all columns.\\n\\n---\\n\\n## Step 3: New Diff API Route\\n\\n**Create**: `app/api/projects/[projectId]/epics/[epicId]/diff/route.ts`\\n\\nGET handler that:\\n1. Looks up `epic.branchName` and `project.gitRepoPath`\\n2. Runs `git diff main...branchName` via `simple-git` (already in project)\\n3. Runs `git diff main...branchName --numstat` for per-file stats\\n4. Returns `{ data: { diff, files, baseBranch, headBranch } }`\\n\\nKey details:\\n- Auto-detect main branch name (`main` or `master`)\\n- Handle missing branch gracefully (400 error)\\n- Parse `--numstat` into `Array<{ file, additions, deletions }>`\\n- Follow existing API pattern from `lib/git/manager.ts` for `simple-git` usage\\n\\n---\\n\\n## Step 4: `useDiff` Hook\\n\\n**Create**: `hooks/useDiff.ts`\\n\\n```typescript\\nexport function useDiff(projectId: string, epicId: string | null, enabled: boolean)\\n// Returns: { data: DiffData | null, loading, error, refresh }\\n```\\n\\n- `enabled` param prevents fetch until modal opens (avoids wasted API calls)\\n- No polling — diff is a snapshot; manual refresh via button\\n- Returns raw diff text for parser + structured file list for sidebar\\n\\n---\\n\\n## Step 5: Extend `useEpicComments` Hook\\n\\n**Modify**: `hooks/useEpicComments.ts`\\n\\nChange `addComment` signature from `(content: string)` to `(content: string, filePath?: string, lineNumber?: number)` and pass the new fields in the POST body.\\n\\n---\\n\\n## Step 6: Install Dependencies\\n\\n```bash\\nnpm install react-diff-view unidiff\\n```\\n\\n- `react-diff-view` v3 — React components for unified/split diff rendering with widget system\\n- `unidiff` — Parser for unified diff format\\n\\n---\\n\\n## Step 7: Diff Parser Utility\\n\\n**Create**: `lib/diff/parser.ts`\\n\\nUtility to parse raw unified diff text into structured `DiffFile[]` with hunks and lines. Can also use `react-diff-view`'s built-in `parseDiff` — evaluate at implementation time which is cleaner.\\n\\nExports:\\n- `DiffFile { oldPath, newPath, status, hunks[] }`\\n- `DiffHunk { oldStart, oldLines, newStart, newLines, header, lines[] }`\\n- `DiffLine { type: \\\"add\\\"|\\\"delete\\\"|\\\"normal\\\", content, oldLineNumber?, newLineNumber? }`\\n\\n---\\n\\n## Step 8: DiffViewer Components\\n\\n**Create 4 components in `components/diff/`:**\\n\\n### `EpicDiffViewer.tsx` — Full-screen Dialog container\\n- Wraps everything in a shadcn `Dialog` with `max-w-[95vw] h-[90vh]`\\n- Three-zone layout: file sidebar (250px) | diff content (flex-1) | bottom general comments (collapsible)\\n- Uses `useDiff` + `useEpicComments`\\n- Separates comments into inline (has filePath+lineNumber) vs general\\n- Toggle for unified/split view mode\\n- Header shows `baseBranch...headBranch` with refresh button\\n\\n### `DiffFileTree.tsx` — Left sidebar\\n- Lists changed files with `+N` / `-N` stats (green/red)\\n- Comment count badge per file\\n- Click to scroll to that file in the diff\\n- \\\"All files\\\" option to show full diff\\n\\n### `DiffContent.tsx` — Main diff rendering area\\n- Renders parsed diff files as collapsible sections\\n- Each line: old/new line numbers in gutter + colored content\\n- Hover on any line shows a \\\"+\\\" comment button\\n- Click inserts `InlineCommentWidget` below that line\\n- Existing inline comments rendered below their anchored lines\\n- Dark mode colors: `bg-green-950/30` for additions, `bg-red-950/30` for deletions\\n\\n### `InlineCommentWidget.tsx` — Comment form between diff lines\\n- Shows existing comments for this file+line (with `MarkdownContent`)\\n- Textarea for new comment (reuse `MentionTextarea` for @mentions)\\n- Submit calls `addComment(content, filePath, lineNumber)`\\n- Cancel collapses the widget\\n\\n### General comments — reuse `CommentThread` pattern\\n- Bottom collapsible panel showing only comments where `filePath` is null\\n- Standard comment input for general observations\\n\\n---\\n\\n## Step 9: Integration in EpicDetail\\n\\n**Modify**: `components/kanban/EpicDetail.tsx`\\n\\n1. Add state: `const [diffViewerOpen, setDiffViewerOpen] = useState(false)`\\n2. Add \\\"View Diff\\\" button in the branch section (after line 382, near branch name):\\n   ```tsx\\n   <Button size=\\\"sm\\\" variant=\\\"outline\\\" onClick={() => setDiffViewerOpen(true)}>\\n     <FileDiff className=\\\"h-3 w-3 mr-1\\\" /> View Diff\\n   </Button>\\n   ```\\n3. Render `<EpicDiffViewer>` conditionally when `epic.branchName` exists\\n4. Only shows when epic has a branch (the surrounding `{epic.branchName && ...}` block handles this)\\n\\n---\\n\\n## Implementation Order\\n\\n```\\nStep 1 (Schema) ──┬──> Step 2 (Comments API) ──> Step 5 (useEpicComments)\\n                  │\\n                  └──> Step 3 (Diff API) ──> Step 4 (useDiff hook)\\n                                                      │\\nStep 6 (npm install) ──────────────────────────────────┤\\n                                                      │\\nStep 7 (Parser) ───────────────────────────────────────┤\\n                                                      │\\n                                               Step 8 (Components)\\n                                                      │\\n                                               Step 9 (Integration)\\n```\\n\\nSteps 2+3 can be parallelized. Steps 4+5 can be parallelized. Step 6 is independent.\\n\\n---\\n\\n## Key Files Reference\\n\\n| File | Role |\\n|------|------|\\n| `lib/db/schema.ts:190` | `ticketComments` table — add columns here |\\n| `hooks/useComments.ts:5` | `TicketComment` interface — add fields here |\\n| `hooks/useEpicComments.ts:40` | `addComment()` — extend signature here |\\n| `app/api/.../comments/route.ts:62` | POST insert — add fields here |\\n| `components/kanban/EpicDetail.tsx:378` | Branch section — button goes here |\\n| `lib/git/manager.ts` | Reference for `simple-git` usage patterns |\\n| `components/ui/dialog.tsx` | Dialog primitive to use for modal |\\n| `components/story/CommentThread.tsx` | Reference for comment rendering pattern |\\n\\n---\\n\\n## Verification\\n\\n1. **Schema**: After migration, confirm `file_path` and `line_number` columns exist in `ticket_comments` table\\n2. **Diff API**: `curl localhost:3000/api/projects/{id}/epics/{id}/diff` returns diff JSON for an epic with a branch\\n3. **UI**: Open an epic with a branch, click \\\"View Diff\\\", verify:\\n   - Full-screen modal opens with file sidebar and diff content\\n   - Files listed with correct +/- counts\\n   - Click a file to scroll to it\\n   - Hover on diff line shows comment button\\n   - Add inline comment → appears anchored to that line\\n   - Add general comment → appears in bottom section\\n   - Both comment types visible in the regular epic comment thread\\n4. **Edge cases**: Epic with no branch → no \\\"View Diff\\\" button; empty diff → \\\"No changes\\\" message; large diff → renders without hanging\\n\"}},{\"tool_name\":\"ExitPlanMode\",\"tool_use_id\":\"toolu_013Et3rdtBXcpyLnXXXwtJ33\",\"tool_input\":{\"allowedPrompts\":[{\"tool\":\"Bash\",\"prompt\":\"install npm dependencies\"},{\"tool\":\"Bash\",\"prompt\":\"run drizzle-kit generate and push migrations\"},{\"tool\":\"Bash\",\"prompt\":\"run dev server for testing\"}],\"plan\":\"# Epic Diff Viewer with Inline Comments\\n\\n## Context\\n\\nWhen an epic is done (or in progress with a branch), there is no way to see what code was changed. Users must leave the Arij interface to inspect diffs via git CLI or GitHub. This epic adds a \\\"View Diff\\\" button on the epic detail panel that opens a full-screen modal showing the `main...branch` diff, with both inline line-anchored comments and a general comment box. All comments are stored in the existing `ticketComments` table.\\n\\n## Design Decisions\\n\\n- **Library**: `react-diff-view` + `unidiff` for React-native diff rendering with built-in widget system for inline comments\\n- **Layout**: Full-screen Dialog (95vw x 90vh) — three-zone layout: file sidebar, diff content, general comments\\n- **Comment modes**: Inline (anchored to file+line) AND general comment box\\n- **Storage**: Extend `ticketComments` with nullable `filePath` + `lineNumber` columns\\n- **Diff source**: `git diff main...branchName` (three-dot = only branch changes since divergence)\\n- **Custom renderer preferred over react-diff-view's default CSS** to avoid Tailwind/dark-mode conflicts\\n\\n---\\n\\n## Step 1: Schema Migration\\n\\nAdd two nullable columns to `ticketComments`.\\n\\n**Modify**: `lib/db/schema.ts` (line 190-200)\\n\\n```typescript\\n// Add after agentSessionId, before createdAt:\\nfilePath: text(\\\"file_path\\\"),        // nullable — set for inline diff comments\\nlineNumber: integer(\\\"line_number\\\"), // nullable — set for inline diff comments\\n```\\n\\n**Run**: `npx drizzle-kit generate && npx drizzle-kit push`\\n\\n**Modify**: `hooks/useComments.ts` (line 5-13) — add to `TicketComment` interface:\\n```typescript\\nfilePath?: string | null;\\nlineNumber?: number | null;\\n```\\n\\n---\\n\\n## Step 2: Update Comments API\\n\\n**Modify**: `app/api/projects/[projectId]/epics/[epicId]/comments/route.ts`\\n\\nIn the POST handler (line 62-71), add `filePath` and `lineNumber` to the `values` object:\\n```typescript\\nfilePath: body.filePath || null,\\nlineNumber: body.lineNumber ?? null,\\n```\\n\\nNo change needed for GET — `select()` already returns all columns.\\n\\n---\\n\\n## Step 3: New Diff API Route\\n\\n**Create**: `app/api/projects/[projectId]/epics/[epicId]/diff/route.ts`\\n\\nGET handler that:\\n1. Looks up `epic.branchName` and `project.gitRepoPath`\\n2. Runs `git diff main...branchName` via `simple-git` (already in project)\\n3. Runs `git diff main...branchName --numstat` for per-file stats\\n4. Returns `{ data: { diff, files, baseBranch, headBranch } }`\\n\\nKey details:\\n- Auto-detect main branch name (`main` or `master`)\\n- Handle missing branch gracefully (400 error)\\n- Parse `--numstat` into `Array<{ file, additions, deletions }>`\\n- Follow existing API pattern from `lib/git/manager.ts` for `simple-git` usage\\n\\n---\\n\\n## Step 4: `useDiff` Hook\\n\\n**Create**: `hooks/useDiff.ts`\\n\\n```typescript\\nexport function useDiff(projectId: string, epicId: string | null, enabled: boolean)\\n// Returns: { data: DiffData | null, loading, error, refresh }\\n```\\n\\n- `enabled` param prevents fetch until modal opens (avoids wasted API calls)\\n- No polling — diff is a snapshot; manual refresh via button\\n- Returns raw diff text for parser + structured file list for sidebar\\n\\n---\\n\\n## Step 5: Extend `useEpicComments` Hook\\n\\n**Modify**: `hooks/useEpicComments.ts`\\n\\nChange `addComment` signature from `(content: string)` to `(content: string, filePath?: string, lineNumber?: number)` and pass the new fields in the POST body.\\n\\n---\\n\\n## Step 6: Install Dependencies\\n\\n```bash\\nnpm install react-diff-view unidiff\\n```\\n\\n- `react-diff-view` v3 — React components for unified/split diff rendering with widget system\\n- `unidiff` — Parser for unified diff format\\n\\n---\\n\\n## Step 7: Diff Parser Utility\\n\\n**Create**: `lib/diff/parser.ts`\\n\\nUtility to parse raw unified diff text into structured `DiffFile[]` with hunks and lines. Can also use `react-diff-view`'s built-in `parseDiff` — evaluate at implementation time which is cleaner.\\n\\nExports:\\n- `DiffFile { oldPath, newPath, status, hunks[] }`\\n- `DiffHunk { oldStart, oldLines, newStart, newLines, header, lines[] }`\\n- `DiffLine { type: \\\"add\\\"|\\\"delete\\\"|\\\"normal\\\", content, oldLineNumber?, newLineNumber? }`\\n\\n---\\n\\n## Step 8: DiffViewer Components\\n\\n**Create 4 components in `components/diff/`:**\\n\\n### `EpicDiffViewer.tsx` — Full-screen Dialog container\\n- Wraps everything in a shadcn `Dialog` with `max-w-[95vw] h-[90vh]`\\n- Three-zone layout: file sidebar (250px) | diff content (flex-1) | bottom general comments (collapsible)\\n- Uses `useDiff` + `useEpicComments`\\n- Separates comments into inline (has filePath+lineNumber) vs general\\n- Toggle for unified/split view mode\\n- Header shows `baseBranch...headBranch` with refresh button\\n\\n### `DiffFileTree.tsx` — Left sidebar\\n- Lists changed files with `+N` / `-N` stats (green/red)\\n- Comment count badge per file\\n- Click to scroll to that file in the diff\\n- \\\"All files\\\" option to show full diff\\n\\n### `DiffContent.tsx` — Main diff rendering area\\n- Renders parsed diff files as collapsible sections\\n- Each line: old/new line numbers in gutter + colored content\\n- Hover on any line shows a \\\"+\\\" comment button\\n- Click inserts `InlineCommentWidget` below that line\\n- Existing inline comments rendered below their anchored lines\\n- Dark mode colors: `bg-green-950/30` for additions, `bg-red-950/30` for deletions\\n\\n### `InlineCommentWidget.tsx` — Comment form between diff lines\\n- Shows existing comments for this file+line (with `MarkdownContent`)\\n- Textarea for new comment (reuse `MentionTextarea` for @mentions)\\n- Submit calls `addComment(content, filePath, lineNumber)`\\n- Cancel collapses the widget\\n\\n### General comments — reuse `CommentThread` pattern\\n- Bottom collapsible panel showing only comments where `filePath` is null\\n- Standard comment input for general observations\\n\\n---\\n\\n## Step 9: Integration in EpicDetail\\n\\n**Modify**: `components/kanban/EpicDetail.tsx`\\n\\n1. Add state: `const [diffViewerOpen, setDiffViewerOpen] = useState(false)`\\n2. Add \\\"View Diff\\\" button in the branch section (after line 382, near branch name):\\n   ```tsx\\n   <Button size=\\\"sm\\\" variant=\\\"outline\\\" onClick={() => setDiffViewerOpen(true)}>\\n     <FileDiff className=\\\"h-3 w-3 mr-1\\\" /> View Diff\\n   </Button>\\n   ```\\n3. Render `<EpicDiffViewer>` conditionally when `epic.branchName` exists\\n4. Only shows when epic has a branch (the surrounding `{epic.branchName && ...}` block handles this)\\n\\n---\\n\\n## Implementation Order\\n\\n```\\nStep 1 (Schema) ──┬──> Step 2 (Comments API) ──> Step 5 (useEpicComments)\\n                  │\\n                  └──> Step 3 (Diff API) ──> Step 4 (useDiff hook)\\n                                                      │\\nStep 6 (npm install) ──────────────────────────────────┤\\n                                                      │\\nStep 7 (Parser) ───────────────────────────────────────┤\\n                                                      │\\n                                               Step 8 (Components)\\n                                                      │\\n                                               Step 9 (Integration)\\n```\\n\\nSteps 2+3 can be parallelized. Steps 4+5 can be parallelized. Step 6 is independent.\\n\\n---\\n\\n## Key Files Reference\\n\\n| File | Role |\\n|------|------|\\n| `lib/db/schema.ts:190` | `ticketComments` table — add columns here |\\n| `hooks/useComments.ts:5` | `TicketComment` interface — add fields here |\\n| `hooks/useEpicComments.ts:40` | `addComment()` — extend signature here |\\n| `app/api/.../comments/route.ts:62` | POST insert — add fields here |\\n| `components/kanban/EpicDetail.tsx:378` | Branch section — button goes here |\\n| `lib/git/manager.ts` | Reference for `simple-git` usage patterns |\\n| `components/ui/dialog.tsx` | Dialog primitive to use for modal |\\n| `components/story/CommentThread.tsx` | Reference for comment rendering pattern |\\n\\n---\\n\\n## Verification\\n\\n1. **Schema**: After migration, confirm `file_path` and `line_number` columns exist in `ticket_comments` table\\n2. **Diff API**: `curl localhost:3000/api/projects/{id}/epics/{id}/diff` returns diff JSON for an epic with a branch\\n3. **UI**: Open an epic with a branch, click \\\"View Diff\\\", verify:\\n   - Full-screen modal opens with file sidebar and diff content\\n   - Files listed with correct +/- counts\\n   - Click a file to scroll to it\\n   - Hover on diff line shows comment button\\n   - Add inline comment → appears anchored to that line\\n   - Add general comment → appears in bottom section\\n   - Both comment types visible in the regular epic comment thread\\n4. **Edge cases**: Epic with no branch → no \\\"View Diff\\\" button; empty diff → \\\"No changes\\\" message; large diff → renders without hanging\\n\"}}],\"uuid\":\"a4ed5d5a-3190-41cc-9087-bb22b20801ea\"}",
        "metadata": null,
        "created_at": "2026-02-15T12:53:20.015Z"
      },
      {
        "id": "rfvnM9nwp9AX",
        "project_id": "cUfHlegssamR",
        "conversation_id": "40I-wrNE1jbH",
        "role": "user",
        "content": "Generate the final epic with user stories based on our discussion.",
        "metadata": null,
        "created_at": "2026-02-15T13:20:19.821Z"
      }
    ],
    "attachments": []
  }
}
